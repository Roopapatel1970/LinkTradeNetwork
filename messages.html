<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Messages ‚Äì LinkTradeNetwork</title>
<style>
  :root{
    --bg:#f3f4f6; --ink:#111827; --muted:#6b7280; --line:#e5e7eb;
    --card:#ffffff; --brand:#0a66c2; --brand2:#004182; --hover:#f8fafc;
  }
  *{box-sizing:border-box}
  body{margin:0;background:var(--bg);color:var(--ink);
       font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Inter,Roboto,Arial}
  a{color:inherit;text-decoration:none}

  /* Top bar */
  header{background:#64748b;color:#fff;box-shadow:0 2px 10px rgba(0,0,0,.12)}
  .bar{max-width:1100px;margin:0 auto;padding:12px 16px;
       display:flex;align-items:center;justify-content:space-between}
  .brand{display:flex;gap:10px;align-items:center}
  .brand b{font-size:18px}
  .nav a{color:#fff;opacity:.95;margin-left:12px}
  .nav a:hover{opacity:.85}

  /* Layout */
  .wrap{max-width:1100px;margin:14px auto;padding:0 14px}
  .shell{display:grid;grid-template-columns:320px 1fr;gap:14px;
         height:calc(100vh - 130px)}
  .card{background:var(--card);border:1px solid var(--line);border-radius:12px;
        box-shadow:0 1px 2px rgba(0,0,0,.04)}

  /* Left: thread list */
  .left{display:grid;grid-template-rows:auto 1fr}
  .left .tools{padding:10px;border-bottom:1px solid #f1f5f9}
  .search{display:flex;gap:8px}
  .search input{flex:1;border:1px solid var(--line);border-radius:999px;padding:.55rem .9rem}
  .threads{overflow:auto}
  .thread{display:grid;grid-template-columns:44px 1fr auto;gap:10px;
          padding:10px;border-bottom:1px solid #f1f5f9;cursor:pointer}
  .thread:hover{background:var(--hover)}
  .avatar{width:44px;height:44px;border-radius:50%;background:#eef2ff;
          display:flex;align-items:center;justify-content:center;overflow:hidden}
  .avatar img{width:100%;height:100%;object-fit:cover}
  .t-title{font-weight:800;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
  .t-sub{color:var(--muted);font-size:12px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
  .t-meta{display:flex;flex-direction:column;align-items:flex-end;gap:6px}
  .time{color:var(--muted);font-size:11px}
  .dot{width:8px;height:8px;background:#22c55e;border-radius:999px;display:none}
  .unread .dot{display:inline-block}

  .empty{color:#6b7280;text-align:center;padding:16px}

  /* Right: chat */
  .chat{display:grid;grid-template-rows:auto 1fr auto;height:100%}
  .head{display:flex;gap:10px;align-items:center;padding:10px 12px;
        border-bottom:1px solid #f1f5f9}
  .head .avatar{width:40px;height:40px}
  .head .name{font-weight:800}
  .head .meta{font-size:12px;color:var(--muted)}
  .head .actions{margin-left:auto;display:flex;gap:8px}
  .btn{background:var(--brand);color:#fff;border:none;border-radius:8px;
       padding:.45rem .75rem;font-weight:800;cursor:pointer}
  .btn.gray{background:#6b7280}.btn.gray:hover{background:#4b5563}
  .btn:hover{background:var(--brand2)}
  .btn.ghost{background:transparent;border:1px solid #e5e7eb;color:#334155}
  .btn.ghost:hover{background:#eef2ff}

  .msgs{overflow:auto;padding:12px;background:#fff}
  .bubble{max-width:70%;margin:6px 0;padding:10px 12px;border-radius:14px;line-height:1.5}
  .me{margin-left:auto;background:#e7f0ff;border:1px solid #c7daf8}
  .them{background:#f3f4f6;border:1px solid #e5e7eb}
  .ts{font-size:11px;color:#9aa3af;margin-top:2px}

  .composer{display:flex;gap:8px;border-top:1px solid #f1f5f9;padding:10px}
  .composer textarea{flex:1;border:1px solid #e5e7eb;border-radius:12px;
                     padding:.6rem .9rem;min-height:44px;max-height:200px;resize:vertical}
  .hint{font-size:12px;color:#9aa3af;margin-left:6px}

  /* Modal (New message) */
  .modal{position:fixed;inset:0;background:rgba(0,0,0,.35);display:none;align-items:center;justify-content:center}
  .modal.show{display:flex}
  .dialog{background:#fff;border-radius:12px;box-shadow:0 12px 40px rgba(0,0,0,.25);width:min(560px,92vw);border:1px solid #e5e7eb}
  .dialog .head{border-bottom:1px solid #f1f5f9}
  .dialog .body{padding:12px}
  .row{display:flex;gap:8px;align-items:center}
  .list{max-height:340px;overflow:auto;margin-top:8px}
  .item{display:flex;gap:10px;align-items:center;padding:8px;border-radius:10px;cursor:pointer}
  .item:hover{background:#f8fafc}

  @media (max-width:900px){ .shell{grid-template-columns:1fr} .threads{height:260px} }
</style>
</head>
<body>
<header>
  <div class="bar">
    <a class="brand" href="front.html" aria-label="Home"><span style="font-size:22px">üåç</span><b>LinkTradeNetwork</b></a>
    <div class="nav">
      <a href="front.html">Home</a>
      <a href="network.html">Network</a>
      <a href="my-profile.html">My Profile</a>
    </div>
  </div>
</header>

<main class="wrap">
  <div class="shell">
    <!-- LEFT: thread list -->
    <aside class="card left">
      <div class="tools">
        <div class="search">
          <input id="searchBox" placeholder="Search messages" />
          <button class="btn" id="newBtn" type="button">New</button>
        </div>
      </div>
      <div id="threadList" class="threads"></div>
    </aside>

    <!-- RIGHT: chat -->
    <section class="card chat">
      <div class="head" id="chatHead">
        <div class="avatar" id="headAvatar">üë§</div>
        <div>
          <div class="name" id="headName">Select a conversation</div>
          <div class="meta" id="headMeta"></div>
        </div>
        <div class="actions">
          <button class="btn ghost" id="deleteBtn" type="button" disabled>Clear</button>
        </div>
      </div>

      <div class="msgs" id="msgs">
        <div style="color:#6b7280;text-align:center;margin-top:20px">No conversation selected.</div>
      </div>

      <div class="composer">
        <textarea id="msgInput" placeholder="Write a message (Enter to send, Shift+Enter for newline)" disabled></textarea>
        <button class="btn" id="sendBtn" disabled>Send</button>
      </div>
      <div class="hint" id="sendHint" style="padding:0 10px 10px"> </div>
    </section>
  </div>
</main>

<!-- New message modal -->
<div class="modal" id="modal">
  <div class="dialog">
    <div class="head" style="padding:10px 12px">
      <strong>New message</strong>
      <div style="margin-left:auto">
        <button class="btn gray" id="closeModal" type="button">Close</button>
      </div>
    </div>
    <div class="body">
      <div class="row">
        <input id="pickSearch" placeholder="Search your connections" style="flex:1;border:1px solid #e5e7eb;border-radius:8px;padding:.55rem .8rem">
      </div>
      <div id="pickList" class="list"></div>
    </div>
  </div>
</div>

<script>
/* ===== storage keys ===== */
const PKEY='ltnPeople';            // people directory
const CKEY='ltnConnections';       // accepted connections
const MEKEY='userProfile:v1';      // your profile
const MSG = id => 'ltnMsgs:'+id;   // per-contact messages

/* ===== helpers ===== */
const $ = id => document.getElementById(id);
function load(key, def){ try{ return JSON.parse(localStorage.getItem(key)) ?? def } catch { return def } }
function save(key, val){ localStorage.setItem(key, JSON.stringify(val)) }
function nowISO(){ return new Date().toISOString() }
function nameOf(p){ return `${p.firstName||''} ${p.lastName||''}`.trim() || (p.email||'Unknown') }
function avatarHtml(p){ return p?.photo ? `<img src="${p.photo}" alt="">` : 'üë§' }
function relTime(iso){
  if(!iso) return '';
  const s = (Date.now() - new Date(iso).getTime())/1000;
  if(s < 60) return 'now';
  const m = Math.floor(s/60);
  if(m < 60) return m+'m';
  const h = Math.floor(m/60);
  if(h < 24) return h+'h';
  const d = Math.floor(h/24);
  return d+'d';
}

/* ===== state ===== */
let me = load(MEKEY, null);
let connections = new Set(load(CKEY, []));
let people = load(PKEY, []);
let currentId = null;
let filter = '';

/* ===== DOM refs ===== */
const threadList = $('threadList');
const searchBox  = $('searchBox');
const newBtn     = $('newBtn');

const headAvatar = $('headAvatar');
const headName   = $('headName');
const headMeta   = $('headMeta');
const deleteBtn  = $('deleteBtn');

const msgs    = $('msgs');
const msgInput= $('msgInput');
const sendBtn = $('sendBtn');
const sendHint= $('sendHint');

const modal = $('modal');
const pickList = $('pickList');
const pickSearch = $('pickSearch');
const closeModal = $('closeModal');

/* ===== thread list ===== */
function lastMsgFor(id){
  const arr = load(MSG(id), []);
  if(!arr.length) return { text:'', ts:0, unread:0 };
  const unread = arr.filter(m=>m.from!=='me' && !m.read).length;
  return { text: arr[arr.length-1].text, ts: arr[arr.length-1].ts, unread };
}
function buildThreads(){
  const list = [...connections].map(id=>{
    const p = people.find(x=>x.id===id);
    if(!p) return null;
    const last = lastMsgFor(id);
    return { id, name: nameOf(p), photo: p.photo||'', trade:p.trade||'', location:p.location||'', last };
  }).filter(Boolean);

  // filter by search
  const q = filter.toLowerCase();
  const filtered = list.filter(t=>{
    if(!q) return true;
    const hay = (t.name+' '+t.trade+' '+t.location+' '+t.last.text).toLowerCase();
    return hay.includes(q);
  });

  // sort by last timestamp desc
  filtered.sort((a,b)=> new Date(b.last.ts).getTime() - new Date(a.last.ts).getTime());

  threadList.innerHTML = filtered.length ? filtered.map(t=>`
    <div class="thread ${t.last.unread ? 'unread':''}" data-id="${t.id}">
      <div class="avatar">${t.photo?`<img src="${t.photo}" alt="">`:'üë§'}</div>
      <div>
        <div class="t-title">${t.name}</div>
        <div class="t-sub">${t.last.text || 'Say hello'}</div>
      </div>
      <div class="t-meta">
        <span class="time">${t.last.ts ? relTime(t.last.ts) : ''}</span>
        <span class="dot"></span>
      </div>
    </div>
  `).join('') : `<div class="empty">No conversations. Start one with <b>New</b> or connect via the <a href="network.html">Network</a>.</div>`;

  document.querySelectorAll('.thread').forEach(el=>{
    el.onclick = () => openChat(el.getAttribute('data-id'));
  });
}

/* ===== chat view ===== */
function openChat(id){
  const p = people.find(x=>x.id===id);
  if(!p){ return; }
  currentId = id;

  headAvatar.innerHTML = avatarHtml(p);
  headName.textContent = nameOf(p);
  headMeta.textContent = [p.trade||'', p.location||'', p.email||''].filter(Boolean).join(' ‚Ä¢ ');
  deleteBtn.disabled = false;

  msgInput.disabled = false; sendBtn.disabled = false; msgInput.focus();

  markAllRead(id);
  renderMessages();
  buildThreads(); // refresh unread dots/times
}
function markAllRead(id){
  const key = MSG(id);
  const arr = load(key, []);
  let changed = false;
  arr.forEach(m=>{ if(m.from!=='me' && !m.read){ m.read = true; changed = true; }});
  if(changed){ save(key, arr); }
}
function renderMessages(){
  const key = MSG(currentId);
  const arr = load(key, []);
  msgs.innerHTML = arr.map(m=>`
    <div class="bubble ${m.from==='me'?'me':'them'}">
      ${m.text}
      <div class="ts">${new Date(m.ts).toLocaleString()}</div>
    </div>
  `).join('');
  msgs.scrollTop = msgs.scrollHeight;
}

/* ===== sending ===== */
function send(){
  const text = (msgInput.value || '').trim();
  if(!text || !currentId) return;
  const key = MSG(currentId);
  const arr = load(key, []);
  arr.push({ from:'me', text, ts: nowISO(), read:true });
  save(key, arr);
  msgInput.value = '';
  renderMessages();
  buildThreads();
}
sendBtn.onclick = send;
msgInput.addEventListener('keydown', e=>{
  if(e.key==='Enter' && !e.shiftKey){
    e.preventDefault(); send();
  }
});

/* ===== delete conversation ===== */
deleteBtn.onclick = ()=>{
  if(!currentId) return;
  if(confirm('Clear this conversation?')){
    save(MSG(currentId), []);
    renderMessages(); buildThreads();
  }
};

/* ===== new message modal ===== */
function openModal(){ modal.classList.add('show'); pickSearch.value=''; renderPick(); }
function closeModalFn(){ modal.classList.remove('show'); }
function renderPick(){
  const q = pickSearch.value.toLowerCase().trim();
  const candidates = people.filter(p=> connections.has(p.id)).filter(p=>{
    if(p.id === currentId) return true;
    if(!q) return true;
    const hay = (nameOf(p)+' '+(p.trade||'')+' '+(p.location||'')+' '+(p.email||'')).toLowerCase();
    return hay.includes(q);
  });
  pickList.innerHTML = candidates.length ? candidates.map(p=>`
    <div class="item" data-id="${p.id}">
      <div class="avatar">${avatarHtml(p)}</div>
      <div>
        <div style="font-weight:800">${nameOf(p)}</div>
        <div class="muted">${[p.trade||'', p.location||''].filter(Boolean).join(' ‚Ä¢ ')}</div>
      </div>
    </div>
  `).join('') : `<div class="empty">No connections to message. Visit the <a href="network.html">Network</a> page.</div>`;

  document.querySelectorAll('.item').forEach(el=>{
    el.onclick = ()=>{ openChat(el.getAttribute('data-id')); closeModalFn(); };
  });
}
newBtn.onclick = openModal;
closeModal.onclick = closeModalFn;
pickSearch.addEventListener('input', renderPick);
modal.addEventListener('click', (e)=>{ if(e.target===modal) closeModalFn(); });

/* ===== search in threads ===== */
searchBox.addEventListener('input', ()=>{
  filter = searchBox.value;
  buildThreads();
});

/* ===== deep-link (?to=ID) ===== */
function tryDeepLink(){
  const u = new URL(location.href);
  const to = u.searchParams.get('to');
  if(to && connections.has(to)){ openChat(to); }
}

/* ===== init ===== */
(function init(){
  // Ensure arrays exist
  connections = new Set(load(CKEY, []));
  people = load(PKEY, []);
  if(!people || !Array.isArray(people)){ people = []; save(PKEY, people); }
  buildThreads();
  tryDeepLink();
  sendHint.textContent = 'Tip: Press Enter to send, Shift+Enter for a new line.';
})();
</script>
</body>
</html>
