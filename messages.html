<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Messages ‚Äì LinkTradeNetwork</title>
<style>
  :root{
    --bg:#f3f4f6; --ink:#0f172a; --muted:#64748b; --line:#e5e7eb; --card:#ffffff;
    --brand:#0a66c2; --brand2:#004182;
  }
  *{box-sizing:border-box}
  body{margin:0;background:var(--bg);color:var(--ink);
       font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Inter,Roboto,Arial;height:100vh;display:flex;flex-direction:column}
  a{color:inherit;text-decoration:none}

  /* Header */
  header{background:#64748b;color:#fff;box-shadow:0 2px 10px rgba(0,0,0,.12)}
  .bar{max-width:1200px;margin:0 auto;padding:12px 16px;display:flex;align-items:center;justify-content:space-between}
  .brand{display:flex;gap:10px;align-items:center;text-decoration:none;color:#fff}
  .brand b{font-size:18px}
  .nav a{color:#fff;margin-left:12px;text-decoration:none;opacity:.95}
  .nav a:hover{opacity:.85}

  /* Layout */
  main{flex:1;display:grid;grid-template-columns:320px 1fr;height:calc(100vh - 60px)}
  .list{background:#fff;border-right:1px solid var(--line);overflow:auto}
  .list-head{display:flex;align-items:center;justify-content:space-between;padding:12px 16px;border-bottom:1px solid var(--line)}
  .list h2{font-size:16px;margin:0}
  .list a.small{font-size:12px;color:#0ea5e9;text-decoration:underline}

  .item{display:grid;grid-template-columns:44px 1fr auto;gap:10px;padding:10px 16px;border-bottom:1px solid #f1f5f9;cursor:pointer}
  .item:hover{background:#f8fafc}
  .item.active{background:#e0e7ff}
  .ava{width:44px;height:44px;border-radius:50%;background:#eef2ff;display:flex;align-items:center;justify-content:center;overflow:hidden}
  .ava img{width:100%;height:100%;object-fit:cover}
  .iname{font-weight:800}
  .ipreview{font-size:12px;color:#64748b;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;max-width:360px}
  .badge{background:#0ea5e9;color:#fff;border-radius:999px;font-size:11px;padding:2px 8px;align-self:center}

  /* Chat */
  .chat{display:flex;flex-direction:column}
  .chat-head{padding:12px 16px;background:#fff;border-bottom:1px solid var(--line);display:flex;align-items:center;gap:10px}
  .chat-body{flex:1;overflow:auto;padding:16px;display:flex;flex-direction:column;gap:10px;background:#f9fafb}
  .bubble{max-width:70%;padding:10px 14px;border-radius:16px;font-size:14px;line-height:1.4}
  .me{align-self:flex-end;background:#dbeafe}
  .them{align-self:flex-start;background:#fff;border:1px solid #e5e7eb}
  .chat-input{display:flex;padding:10px 16px;background:#fff;border-top:1px solid var(--line);gap:10px}
  #msg{flex:1;border:1px solid #d1d5db;border-radius:20px;padding:.6rem .9rem}
  #send{background:var(--brand);color:#fff;border:none;border-radius:20px;padding:.6rem 1rem;font-weight:700;cursor:pointer}
  #send:hover{background:var(--brand2)}

  @media (max-width:900px){
    main{grid-template-columns:1fr}
    .list{display:none}
    body.list-open .list{display:block}
    body.list-open main{grid-template-columns:1fr}
  }
</style>
</head>
<body>

<header>
  <div class="bar">
    <a class="brand" href="../front.html"><span style="font-size:22px">üåç</span><b>LinkTradeNetwork</b></a>
    <div class="nav">
      <a href="../front.html">Home</a>
      <a href="../network.html">Network</a>
      <a href="../messaging.html">Messaging</a>
      <a href="../my-profile.html">My Profile</a>
    </div>
  </div>
</header>

<main>
  <!-- LEFT: conversation list -->
  <aside class="list" id="list">
    <div class="list-head">
      <h2>Messages</h2>
      <a class="small" href="./terms-messaging.html" title="Messaging terms & policy">Terms</a>
    </div>
    <div id="items"></div>
  </aside>

  <!-- RIGHT: chat window -->
  <section class="chat">
    <div class="chat-head">
      <div class="ava" id="chatAva">üë§</div>
      <div>
        <div id="chatName" style="font-weight:800">Select a conversation</div>
        <div id="chatSub" style="font-size:12px;color:#64748b"></div>
      </div>
      <div style="margin-left:auto;display:flex;gap:8px">
        <button id="showListBtn" style="display:none;border:1px solid #d1d5db;background:#fff;border-radius:8px;padding:.4rem .6rem;cursor:pointer">Conversations</button>
      </div>
    </div>
    <div class="chat-body" id="chatBody"></div>
    <div class="chat-input">
      <input id="msg" placeholder="Type a message‚Ä¶" disabled>
      <button id="send" disabled>Send</button>
    </div>
  </section>
</main>

<script>
/* Storage keys (shared with other pages) */
const PKEY='ltnPeople', CKEY='ltnConnections', MKEY='ltnMessages';
const $=id=>document.getElementById(id);
function load(k,d){try{return JSON.parse(localStorage.getItem(k))??d}catch{return d}}
function save(k,v){localStorage.setItem(k,JSON.stringify(v))}

/* Data */
let people=load(PKEY,[]);
let connections=new Set(load(CKEY,[]));
let messages=load(MKEY,{});     // { [personId]: [{me:boolean,text:string,ts:number}] }
let active=null;

/* Helpers */
function nameOf(p){return `${p?.firstName||''} ${p?.lastName||''}`.trim()||'Unknown'}
function lastMsgPreview(id){
  const t=messages[id]||[];
  if(!t.length) return '';
  const m=t[t.length-1];
  const who=m.me?'You: ':'';
  return who + (m.text||'').replace(/\s+/g,' ').slice(0,80);
}
function unreadCount(id){
  // Simple demo: count non-me messages since the last me message
  const t=messages[id]||[];
  let count=0;
  for(let i=t.length-1;i>=0;i--){
    if(t[i].me) break;
    count++;
  }
  return count;
}

/* Build list */
function renderList(){
  people=load(PKEY,[]);
  connections=new Set(load(CKEY,[]));
  messages=load(MKEY,{});

  const con=people.filter(p=>connections.has(p.id));
  if(!con.length){
    $('items').innerHTML = `<div style="padding:14px;color:#6b7280">No connections yet. Go to <a href="../network.html" style="text-decoration:underline">Network</a> to connect.</div>`;
    return;
  }

  $('items').innerHTML = con.map(p=>{
    const u=unreadCount(p.id);
    return `
    <div class="item ${active===p.id?'active':''}" data-id="${p.id}">
      <div class="ava">üë§</div>
      <div>
        <div class="iname">${nameOf(p)}</div>
        <div class="ipreview">${lastMsgPreview(p.id) || (p.trade||'')}</div>
      </div>
      <div>${u?`<span class="badge">${u}</span>`:''}</div>
    </div>`;
  }).join('');

  document.querySelectorAll('.item').forEach(el=>{
    el.onclick=()=>openThread(el.dataset.id);
  });
}

/* Open a thread */
function openThread(id){
  active=id;
  renderList();

  const p=people.find(x=>x.id===id);
  $('chatName').textContent=nameOf(p);
  $('chatSub').textContent = p?.trade || p?.location || '';
  $('chatAva').textContent='üë§';
  $('msg').disabled=false; $('send').disabled=false;

  renderThread();
  // on small screens, hide list
  if(window.matchMedia('(max-width: 900px)').matches){
    document.body.classList.remove('list-open');
    $('showListBtn').style.display='inline-block';
  }
}

/* Render thread messages */
function renderThread(){
  const body=$('chatBody');
  body.innerHTML='';
  const thread=messages[active]||[];
  thread.forEach(m=>{
    const div=document.createElement('div');
    div.className='bubble '+(m.me?'me':'them');
    div.textContent=m.text;
    body.appendChild(div);
  });
  body.scrollTop=body.scrollHeight;
}

/* Send a message */
function sendNow(){
  if(!active) return;
  const t=$('msg').value.trim();
  if(!t) return;
  messages[active]=messages[active]||[];
  messages[active].push({me:true,text:t,ts:Date.now()});
  save(MKEY,messages);
  $('msg').value='';
  renderThread();
  renderList();

  // Simulated reply (demo)
  setTimeout(()=>{
    messages[active].push({me:false,text:'Got it ‚Äî thanks!',ts:Date.now()});
    save(MKEY,messages);
    renderThread();
    renderList();
  },800);
}
$('send').onclick=sendNow;
$('msg').addEventListener('keydown',e=>{ if(e.key==='Enter'){ e.preventDefault(); sendNow(); }});

/* Deep links: ?to=<id> */
(function(){
  const sp=new URLSearchParams(location.search);
  const id=sp.get('to');
  renderList();
  if(id){
    // open after initial render
    setTimeout(()=> openThread(id), 150);
    if(history.replaceState){ history.replaceState({}, document.title, 'messages.html'); }
  }
})();

/* Mobile: show list button */
$('showListBtn').onclick=()=>{
  document.body.classList.toggle('list-open');
  // when list is shown, hide the button
  const show = document.body.classList.contains('list-open');
  $('showListBtn').style.display = show ? 'none' : 'inline-block';
};

// Initial render if no deep link
if(!$('items').innerHTML) renderList();
</script>

</body>
</html>
