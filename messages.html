<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Messaging ‚Äì LinkTradeNetwork</title>
<style>
  :root{
    --bg:#f3f4f6; --ink:#111827; --muted:#6b7280; --line:#e5e7eb;
    --card:#ffffff; --brand:#0a66c2; --brand2:#004182; --hover:#f8fafc;
  }
  *{box-sizing:border-box}
  body{margin:0;background:var(--bg);color:var(--ink);
       font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Inter,Roboto,Arial;line-height:1.6;
       display:flex;flex-direction:column;height:100vh}
  a{color:inherit;text-decoration:none}

  /* Header */
  header{background:#64748b;color:#fff;box-shadow:0 2px 10px rgba(0,0,0,.12)}
  .bar{max-width:1100px;margin:0 auto;padding:12px 16px;
       display:flex;align-items:center;justify-content:space-between}
  .brand{display:flex;gap:10px;align-items:center}
  .brand b{font-size:18px}
  .nav a{color:#fff;opacity:.95;margin-left:12px}
  .nav a:hover{opacity:.85}

  /* Layout */
  main{flex:1;display:grid;grid-template-columns:320px 1fr;gap:14px;max-width:1100px;margin:14px auto;padding:0 14px;width:100%}
  .card{background:var(--card);border:1px solid var(--line);border-radius:12px;box-shadow:0 1px 2px rgba(0,0,0,.04)}

  /* Left (threads) */
  .left{display:grid;grid-template-rows:auto 1fr}
  .tools{padding:10px;border-bottom:1px solid #f1f5f9}
  .search{display:flex;gap:8px}
  .search input{flex:1;border:1px solid var(--line);border-radius:999px;padding:.55rem .9rem}
  .threads{overflow:auto}
  .thread{display:grid;grid-template-columns:44px 1fr auto;gap:10px;
          padding:10px;border-bottom:1px solid #f1f5f9;cursor:pointer}
  .thread:hover{background:var(--hover)}
  .avatar{width:44px;height:44px;border-radius:50%;background:#eef2ff;
          display:flex;align-items:center;justify-content:center;overflow:hidden}
  .avatar img{width:100%;height:100%;object-fit:cover}
  .t-title{font-weight:800;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
  .t-sub{color:var(--muted);font-size:12px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
  .t-meta{display:flex;flex-direction:column;align-items:flex-end;gap:6px}
  .time{color:var(--muted);font-size:11px}
  .dot{width:8px;height:8px;background:#22c55e;border-radius:999px;display:none}
  .unread .dot{display:inline-block}
  .empty{color:#6b7280;text-align:center;padding:16px}

  /* Right (chat) */
  .chat{display:grid;grid-template-rows:auto 1fr auto;height:100%}
  .head{display:flex;gap:10px;align-items:center;padding:10px 12px;border-bottom:1px solid #f1f5f9}
  .head .avatar{width:40px;height:40px}
  .head .name{font-weight:800}
  .head .meta{font-size:12px;color:var(--muted)}
  .head .actions{margin-left:auto;display:flex;gap:8px}
  .btn{background:var(--brand);color:#fff;border:none;border-radius:8px;padding:.45rem .75rem;font-weight:800;cursor:pointer}
  .btn:hover{background:var(--brand2)}
  .btn.gray{background:#6b7280}.btn.gray:hover{background:#4b5563}
  .btn.ghost{background:transparent;border:1px solid #e5e7eb;color:#334155}
  .btn.ghost:hover{background:#eef2ff}

  .msgs{overflow:auto;padding:12px;background:#fff}
  .bubble{max-width:70%;margin:6px 0;padding:10px 12px;border-radius:14px;line-height:1.5}
  .me{margin-left:auto;background:#e7f0ff;border:1px solid #c7daf8}
  .them{background:#f3f4f6;border:1px solid #e5e7eb}
  .ts{font-size:11px;color:#9aa3af;margin-top:2px}

  .composer{display:flex;gap:8px;border-top:1px solid #f1f5f9;padding:10px}
  .composer textarea{flex:1;border:1px solid #e5e7eb;border-radius:12px;padding:.6rem .9rem;min-height:44px;max-height:200px;resize:vertical}

  .footnote{max-width:1100px;margin:0 auto 14px;padding:0 14px}
  .policy{background:#f3f4f6;border:1px solid #e5e7eb;border-radius:10px;text-align:center;padding:.6rem}
  .policy a{color:#2563eb;text-decoration:underline;font-weight:700}

  /* Modal for Messaging Rules */
  .modal{position:fixed;inset:0;background:rgba(0,0,0,.55);display:none;align-items:center;justify-content:center;z-index:1000}
  .modal.show{display:flex}
  .dialog{background:#fff;border-radius:12px;box-shadow:0 12px 40px rgba(0,0,0,.25);width:min(920px,92vw);height:min(80vh,920px);border:1px solid #e5e7eb;display:flex;flex-direction:column}
  .dialog .top{display:flex;align-items:center;gap:10px;padding:10px 12px;border-bottom:1px solid #f1f5f9}
  .dialog .top strong{font-size:16px}
  .dialog .top .x{margin-left:auto;background:#111827;color:#fff;border:none;border-radius:8px;padding:.35rem .7rem;font-weight:800;cursor:pointer}
  .dialog iframe{flex:1;border:0;border-radius:0 0 12px 12px}

  @media (max-width:900px){ main{grid-template-columns:1fr} .threads{height:260px} }
</style>
</head>
<body>
<header>
  <div class="bar">
    <a class="brand" href="front.html" aria-label="Home"><span style="font-size:22px">üåç</span><b>LinkTradeNetwork</b></a>
    <div class="nav">
      <a href="front.html">Home</a>
      <a href="network.html">Network</a>
      <a href="my-profile.html">My Profile</a>
    </div>
  </div>
</header>

<main>
  <!-- LEFT: thread list -->
  <aside class="card left">
    <div class="tools">
      <div class="search">
        <input id="searchBox" placeholder="Search messages" />
        <button class="btn" id="newBtn" type="button">New</button>
      </div>
    </div>
    <div id="threadList" class="threads"></div>
  </aside>

  <!-- RIGHT: chat -->
  <section class="card chat">
    <div class="head" id="chatHead">
      <div class="avatar" id="headAvatar">üë§</div>
      <div>
        <div class="name" id="headName">Select a conversation</div>
        <div class="meta" id="headMeta"></div>
      </div>
      <div class="actions">
        <button class="btn ghost" id="rulesBtn" type="button">Messaging Rules</button>
        <button class="btn ghost" id="deleteBtn" type="button" disabled>Clear</button>
      </div>
    </div>

    <div class="msgs" id="msgs">
      <div style="color:#6b7280;text-align:center;margin-top:20px">No conversation selected.</div>
    </div>

    <div class="composer">
      <textarea id="msgInput" placeholder="Write a message (Enter to send, Shift+Enter for newline)" disabled></textarea>
      <button class="btn" id="sendBtn" disabled>Send</button>
    </div>
  </section>
</main>

<div class="footnote">
  <div class="policy">
    View our <a href="#" id="openPolicyLink">Messaging Policy</a>
  </div>
</div>

<!-- Modal -->
<div class="modal" id="policyModal">
  <div class="dialog">
    <div class="top">
      <strong>Messaging Policy</strong>
      <button class="x" id="closePolicy">‚úï</button>
    </div>
    <iframe src="" title="Messaging Policy"></iframe>
  </div>
</div>

<script>
/* ===== storage keys (shared with other pages) ===== */
const PKEY='ltnPeople';            // directory of people
const CKEY='ltnConnections';       // accepted connections (ids)
const MEKEY='userProfile:v1';      // your profile
const MSG = id => 'ltnMsgs:'+id;   // per-contact messages

/* ===== helpers ===== */
const $ = id => document.getElementById(id);
function load(key, def){ try{ return JSON.parse(localStorage.getItem(key)) ?? def } catch { return def } }
function save(key, val){ localStorage.setItem(key, JSON.stringify(val)) }
function nowISO(){ return new Date().toISOString() }
function nameOf(p){ return `${p.firstName||''} ${p.lastName||''}`.trim() || (p.email||'Unknown') }
function avatarHtml(p){ return p?.photo ? `<img src="${p.photo}" alt="">` : 'üë§' }
function relTime(iso){
  if(!iso) return '';
  const s = (Date.now() - new Date(iso).getTime())/1000;
  if(s < 60) return 'now';
  const m = Math.floor(s/60);
  if(m < 60) return m+'m';
  const h = Math.floor(m/60);
  if(h < 24) return h+'h';
  const d = Math.floor(h/24);
  return d+'d';
}

/* ===== state ===== */
let me = load(MEKEY, null);
let connections = new Set(load(CKEY, []));
let people = load(PKEY, []);
let currentId = null;
let filter = '';

/* ===== DOM refs ===== */
const threadList = $('threadList');
const searchBox  = $('searchBox');
const newBtn     = $('newBtn');

const headAvatar = $('headAvatar');
const headName   = $('headName');
const headMeta   = $('headMeta');
const deleteBtn  = $('deleteBtn');

const msgs    = $('msgs');
const msgInput= $('msgInput');
const sendBtn = $('sendBtn');

const rulesBtn = $('rulesBtn');
const policyLink = $('openPolicyLink');
const policyModal = $('policyModal');
const closePolicy = $('closePolicy');

/* ===== threads ===== */
function lastMsgFor(id){
  const arr = load(MSG(id), []);
  if(!arr.length) return { text:'', ts:0, unread:0 };
  const unread = arr.filter(m=>m.from!=='me' && !m.read).length;
  return { text: arr[arr.length-1].text, ts: arr[arr.length-1].ts, unread };
}
function buildThreads(){
  const list = [...connections].map(id=>{
    const p = people.find(x=>x.id===id);
    if(!p) return null;
    const last = lastMsgFor(id);
    return { id, name: nameOf(p), photo: p.photo||'', trade:p.trade||'', location:p.location||'', last };
  }).filter(Boolean);

  const q = filter.toLowerCase();
  const filtered = list.filter(t=>{
    if(!q) return true;
    const hay = (t.name+' '+t.trade+' '+t.location+' '+t.last.text).toLowerCase();
    return hay.includes(q);
  });

  filtered.sort((a,b)=> new Date(b.last.ts).getTime() - new Date(a.last.ts).getTime());

  threadList.innerHTML = filtered.length ? filtered.map(t=>`
    <div class="thread ${t.last.unread ? 'unread':''}" data-id="${t.id}">
      <div class="avatar">${t.photo?`<img src="${t.photo}" alt="">`:'üë§'}</div>
      <div>
        <div class="t-title">${t.name}</div>
        <div class="t-sub">${t.last.text || 'Say hello'}</div>
      </div>
      <div class="t-meta">
        <span class="time">${t.last.ts ? relTime(t.last.ts) : ''}</span>
        <span class="dot"></span>
      </div>
    </div>
  `).join('') : `<div class="empty">No conversations. Start one with <b>New</b> or connect via the <a href="network.html">Network</a>.</div>`;

  document.querySelectorAll('.thread').forEach(el=>{
    el.onclick = () => openChat(el.getAttribute('data-id'));
  });
}

/* ===== chat view ===== */
function openChat(id){
  const p = people.find(x=>x.id===id);
  if(!p){ return; }
  currentId = id;

  headAvatar.innerHTML = avatarHtml(p);
  headName.textContent = nameOf(p);
  headMeta.textContent = [p.trade||'', p.location||'', p.email||''].filter(Boolean).join(' ‚Ä¢ ');
  deleteBtn.disabled = false;

  msgInput.disabled = false; sendBtn.disabled = false; msgInput.focus();

  markAllRead(id);
  renderMessages();
  buildThreads();
}
function markAllRead(id){
  const key = MSG(id);
  const arr = load(key, []);
  let changed = false;
  arr.forEach(m=>{ if(m.from!=='me' && !m.read){ m.read = true; changed = true; }});
  if(changed){ save(key, arr); }
}
function renderMessages(){
  const key = MSG(currentId);
  const arr = load(key, []);
  msgs.innerHTML = arr.map(m=>`
    <div class="bubble ${m.from==='me'?'me':'them'}">
      ${m.text}
      <div class="ts">${new Date(m.ts).toLocaleString()}</div>
    </div>
  `).join('');
  msgs.scrollTop = msgs.scrollHeight;
}

/* ===== sending ===== */
function send(){
  const text = (msgInput.value || '').trim();
  if(!text || !currentId) return;
  const key = MSG(currentId);
  const arr = load(key, []);
  arr.push({ from:'me', text, ts: nowISO(), read:true });
  save(key, arr);
  msgInput.value = '';
  renderMessages();
  buildThreads();
}
sendBtn.onclick = send;
msgInput.addEventListener('keydown', e=>{
  if(e.key==='Enter' && !e.shiftKey){
    e.preventDefault(); send();
  }
});

/* ===== delete conversation ===== */
deleteBtn.onclick = ()=>{
  if(!currentId) return;
  if(confirm('Clear this conversation?')){
    save(MSG(currentId), []);
    renderMessages(); buildThreads();
  }
};

/* ===== new message modal (simple prompt picker) ===== */
newBtn.onclick = ()=>{
  // Build a quick pick list from connections
  const ids = [...connections];
  if(!ids.length){ alert('No connections yet. Go to the Network page to connect.'); return; }
  const names = ids.map(id=>{
    const p = people.find(x=>x.id===id);
    return p ? `${nameOf(p)} (${id})` : id;
  });
  const choice = prompt('Start chat with (type exact ID):\n' + ids.map((id,i)=>`${ids[i]} ‚Äî ${names[i]}`).join('\n'));
  if(!choice) return;
  if(connections.has(choice)) openChat(choice);
  else alert('Not found. Make sure you typed the ID exactly.');
};

/* ===== search in threads ===== */
searchBox.addEventListener('input', ()=>{
  filter = searchBox.value;
  buildThreads();
});

/* ===== deep-links: ?to=ID or ?new=1 ===== */
function tryDeepLink(){
  const u = new URL(location.href);
  const to = u.searchParams.get('to');
  const newFlag = u.searchParams.get('new');
  if(to && connections.has(to)){
    openChat(to);
  }else if(newFlag === '1'){
    newBtn.click();
  }
}

/* ===== messaging policy modal ===== */
function openPolicy(){ policyModal.classList.add('show'); policyModal.querySelector('iframe').src='terms-messaging.html'; }
function closePolicyModal(){ policyModal.classList.remove('show'); policyModal.querySelector('iframe').src=''; }
rulesBtn.onclick = openPolicy;
policyLink.onclick = (e)=>{ e.preventDefault(); openPolicy(); }
closePolicy.onclick = closePolicyModal;
policyModal.addEventListener('click', (e)=>{ if(e.target===policyModal) closePolicyModal(); });

/* ===== init ===== */
(function init(){
  connections = new Set(load(CKEY, []));
  people = load(PKEY, []);
  if(!Array.isArray(people)) { people = []; save(PKEY, people); }
  buildThreads();
  tryDeepLink();
})();
</script>
</body>
</html>

