<script>
(function(){
  // ⬇️ Use your latest /exec URL here
  const WEB_APP_URL = 'https://script.google.com/macros/s/AKfycbwo08TJlqwagHHH4pIDxD0cxpfStePpxMswKn5GtDFC0zVkTQ01NTB70h-xN-7-53n_qQ/exec';

  const $=s=>document.querySelector(s), $$=s=>Array.from(document.querySelectorAll(s));
  const joinBtn=$('#joinBtn'), joinMsg=$('#joinMsg');
  const stepJoin=$('#step-join'), stepOtp=$('#step-otp'), stepDone=$('#step-done');
  const otpEmail=$('#otpEmail'), otpMsg=$('#otpMsg'), inputs=$$('#otpInputs input'), welcome=$('#welcomeNotice');
  let currentEmail='', currentName='';

  async function callAPI(payload){
    const body = new URLSearchParams();
    for (const [k,v] of Object.entries(payload)) body.append(k, typeof v==='boolean' ? String(v) : String(v ?? ''));
    const res = await fetch(WEB_APP_URL, {
      method: 'POST',
      headers: {'Content-Type':'application/x-www-form-urlencoded;charset=UTF-8'},
      body
    });
    const text = await res.text();
    try { return JSON.parse(text); }
    catch { throw new Error(`HTTP ${res.status}: ${text.slice(0,200)}`); }
  }

  inputs.forEach((inp,i)=>{
    inp.addEventListener('input',()=>{inp.value=inp.value.replace(/\D/g,'').slice(0,1); if(inp.value&&i<inputs.length-1)inputs[i+1].focus();});
    inp.addEventListener('keydown',e=>{if(e.key==='Backspace'&&!inp.value&&i>0)inputs[i-1].focus();});
  });
  const codeValue=()=>inputs.map(i=>i.value).join('');
  const clearCode=()=>{inputs.forEach(i=>i.value=''); inputs[0].focus();};
  const setMsg=(el,t,c='')=>{el.textContent=t||''; el.className='msg '+c;};

  // --- SIGN IN (JOIN) ---
  $('#joinBtn').addEventListener('click', async ()=>{
    const first=$('#firstName').value.trim(), last=$('#lastName').value.trim();
    const email=$('#email').value.trim().toLowerCase(), consent=$('#consent').checked;
    if(!first||!email){setMsg(joinMsg,'First name and email are required','err');return;}
    if(!consent){setMsg(joinMsg,'Please agree to the Terms to continue.','err');return;}
    joinBtn.disabled=true; setMsg(joinMsg,'Working…','');

    try{
      const data = await callAPI({action:'signup',name:first+(last?' '+last:''),email,consent,userAgent:navigator.userAgent});
      if(data.verified && !data.requiresOtp){
        welcome.textContent='Welcome back, '+first+'!';
        welcome.style.display='block';
        stepJoin.classList.add('hide');
        stepDone.classList.remove('hide');
        setMsg(joinMsg,'');

        // ✅ Redirect after short delay
        setTimeout(() => {
          window.location.href = "landingpage.html";
        }, 1500);
        return;
      }
      currentEmail=email; currentName=first; otpEmail.textContent=email;
      welcome.style.display='none'; stepJoin.classList.add('hide'); stepOtp.style.display='block'; clearCode(); setMsg(joinMsg,'');
    }catch(err){ setMsg(joinMsg,String(err.message||err),'err'); }
    finally{ joinBtn.disabled=false; }
  });

  // --- VERIFY OTP ---
  $('#verifyBtn').addEventListener('click', async ()=>{
    const code=codeValue(); if(code.length!==6){setMsg(otpMsg,'Enter the 6-digit code.','err');return;}
    try{
      const data = await callAPI({action:'verify',email:currentEmail,code});
      if(data.verified){
        stepOtp.style.display='none';
        stepDone.classList.remove('hide');
        welcome.textContent='Welcome back, '+currentName+'!';
        welcome.style.display='block';

        // ✅ Redirect after OTP success
        setTimeout(() => {
          window.location.href = "landingpage.html";
        }, 1500);
      } else {
        setMsg(otpMsg,'Unexpected response.','err');
      }
    }catch(err){ setMsg(otpMsg,String(err.message||err),'err'); }
  });

  $('#resendBtn').addEventListener('click', async ()=>{
    try{
      const data = await callAPI({action:'resend',email:currentEmail,name:currentName||'there'});
      if(!data.success){ setMsg(otpMsg, data.error||'Error','err'); return; }
      setMsg(otpMsg,'A new code has been sent.','ok'); clearCode();
    }catch(err){ setMsg(otpMsg,String(err.message||err),'err'); }
  });
})();
</script>







