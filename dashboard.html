<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Customer Dashboard â€“ LinkTradeNetwork</title>
<meta name="color-scheme" content="dark light" />
<style>
  :root{
    --bg:#0b1220; --panel:#0f172a; --ink:#e5e7eb; --muted:#9ca3af;
    --line:#1f2937; --brand:#3b82f6; --brand2:#2563eb; --accent:#fbbf24;
    --good:#22c55e; --bad:#f43f5e;
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{
    margin:0;background:var(--bg);color:var(--ink);
    font:15px/1.5 Inter,system-ui,Segoe UI,Roboto,Arial,sans-serif;
    -webkit-font-smoothing:antialiased; -moz-osx-font-smoothing:grayscale;
  }
  .wrap{max-width:1400px;margin:28px auto;padding:0 16px}
  .header{display:flex;justify-content:space-between;align-items:center;margin-bottom:24px}
  .header h1{display:flex;align-items:center;gap:12px;margin:0}
  .logo{width:38px;height:38px;border-radius:999px;display:grid;place-items:center;background:linear-gradient(135deg,var(--brand),#1d4ed8);font-size:24px}
  .nav-links{display:flex;gap:20px;align-items:center}
  .nav-links a{color:var(--muted);text-decoration:none;transition:color 0.3s}
  .nav-links a:hover{color:var(--ink)}
  .card{background:var(--panel);border:1px solid var(--line);border-radius:14px;padding:14px;box-shadow:0 20px 50px rgba(0,0,0,.35)}
  .toolbar{display:flex;gap:10px;align-items:center;margin:4px 0 12px;flex-wrap:wrap}
  .toolbar input[type="search"]{
    flex:1;min-width:250px;min-height:44px;padding:10px 12px;border:1px solid var(--line);border-radius:12px;
    background:#0b1220;color:var(--ink)
  }
  .btn{padding:10px 16px;border:1px solid var(--line);border-radius:12px;background:#0e1627;color:var(--ink);cursor:pointer;font-size:14px}
  .btn:hover{filter:brightness(1.1)}
  .btn-primary{background:var(--brand);border-color:var(--brand);color:white}
  .pill{display:inline-block;padding:4px 10px;border-radius:999px;font-size:12px;font-weight:500}
  .pill.worker{background:rgba(34,197,94,.12);border:1px solid rgba(34,197,94,.35);color:#86efac}
  .pill.business{background:rgba(59,130,246,.12);border:1px solid rgba(59,130,246,.35);color:#93c5fd}
  .pill.yes{background:rgba(34,197,94,.12);border:1px solid rgba(34,197,94,.35);color:#86efac}
  .ok{color:var(--good)} .bad{color:var(--bad)}
  .status{margin-left:8px;font-size:14px}
  .stats{display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:12px;margin-bottom:16px}
  .stat-card{background:#0e1627;padding:16px;border-radius:12px;border:1px solid var(--line)}
  .stat-label{color:var(--muted);font-size:13px;margin-bottom:4px}
  .stat-value{font-size:28px;font-weight:700;color:var(--ink)}
  .scroller{overflow:auto;max-height:60vh;border:1px solid var(--line);border-radius:12px}
  table{width:100%;border-collapse:collapse}
  thead th{
    position:sticky;top:0;background:#0c1629;border-bottom:1px solid var(--line);
    text-align:left;padding:12px;font-size:13px;color:#cfe0ff;cursor:pointer;user-select:none;white-space:nowrap
  }
  tbody td{padding:12px;border-bottom:1px solid var(--line);vertical-align:top}
  .muted{color:var(--muted)}
  .footer{margin-top:12px;color:var(--muted);font-size:12px}
  .sort{opacity:.7;margin-left:6px}
  @media(max-width:768px){
    .header{flex-direction:column;align-items:flex-start;gap:12px}
    .toolbar{flex-direction:column}
    .toolbar input{width:100%}
  }
</style>
</head>
<body>
<div class="wrap">
  <div class="header">
    <h1>
      <span class="logo">ðŸ‘·</span>
      LinkTradeNetwork Dashboard
    </h1>
    <nav class="nav-links">
      <a href="index.html">Back to Site</a>
    </nav>
  </div>

  <div class="stats">
    <div class="stat-card">
      <div class="stat-label">Total Signups</div>
      <div class="stat-value" id="totalSignups">0</div>
    </div>
    <div class="stat-card">
      <div class="stat-label">Workers</div>
      <div class="stat-value" id="totalWorkers">0</div>
    </div>
    <div class="stat-card">
      <div class="stat-label">Businesses</div>
      <div class="stat-value" id="totalBusinesses">0</div>
    </div>
  </div>

  <div class="card">
    <div class="toolbar">
      <input id="q" type="search" placeholder="Search name, phone, email, or trade..." />
      <button id="exportBtn" class="btn">Export CSV</button>
      <button id="refreshBtn" class="btn btn-primary">Refresh</button>
      <span id="status" class="status"></span>
    </div>

    <div class="scroller">
      <table id="tbl">
        <thead>
          <tr>
            <th data-key="Timestamp">Timestamp <span class="sort">â†•</span></th>
            <th data-key="Name">Name <span class="sort">â†•</span></th>
            <th data-key="Email">Email <span class="sort">â†•</span></th>
            <th data-key="Phone">Phone <span class="sort">â†•</span></th>
            <th data-key="UserType">Type <span class="sort">â†•</span></th>
            <th data-key="Trade">Trade <span class="sort">â†•</span></th>
            <th data-key="Consent">Consent <span class="sort">â†•</span></th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>

    <div class="footer">Newest signups appear first. Click column headers to sort.</div>
  </div>
</div>

<script>
/* =======================
   SET YOUR ENDPOINT HERE
   ======================= */
const DATA_ENDPOINT = "https://script.google.com/macros/s/AKfycbz1wwkb-8GrEht_3ujsVIvbYgjxLTN5MzI8o-MnsvxvrSiY8j2GBoeb9ZNY3Duok_EP/exec";

/* =======================
   PAGE LOGIC
   ======================= */
const tbody   = document.querySelector('#tbl tbody');
const q       = document.getElementById('q');
const statusEl= document.getElementById('status');
const exportBtn = document.getElementById('exportBtn');
const refreshBtn = document.getElementById('refreshBtn');

let rows = [];
let sortKey = 'Timestamp';
let sortDir = 'desc';

function escape_(s){ return String(s).replace(/[&<>"']/g, m=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' }[m])); }
function asBool(v){ return v===true || String(v).toLowerCase()==='true' || String(v).toLowerCase()==='yes' || v===1 || v==='1'; }

function sortRows(arr){
  const dir = sortDir === 'asc' ? 1 : -1;
  return [...arr].sort((a,b)=>{
    let A = a[sortKey], B = b[sortKey];
    if (sortKey==='Timestamp'){
      const dA = new Date(A).getTime()||0, dB = new Date(B).getTime()||0;
      return (dA - dB) * dir;
    }
    A = (A ?? '').toString().toLowerCase();
    B = (B ?? '').toString().toLowerCase();
    return A.localeCompare(B) * dir;
  });
}

function updateStats(data){
  document.getElementById('totalSignups').textContent = data.length;
  document.getElementById('totalWorkers').textContent = data.filter(r=>r.UserType==='Worker').length;
  document.getElementById('totalBusinesses').textContent = data.filter(r=>r.UserType==='Business').length;
}

function render(){
  const term = (q.value || '').toLowerCase().trim();
  let filtered = rows;
  if (term){
    filtered = rows.filter(r =>
      String(r.Name||'').toLowerCase().includes(term) ||
      String(r.Phone||'').toLowerCase().includes(term) ||
      String(r.Email||'').toLowerCase().includes(term) ||
      String(r.Trade||'').toLowerCase().includes(term)
    );
  }
  const sorted = sortRows(filtered);
  tbody.innerHTML = '';
  sorted.forEach(r=>{
    const tr = document.createElement('tr');
    const userTypePill = r.UserType === 'Worker' 
      ? '<span class="pill worker">Worker</span>' 
      : r.UserType === 'Business'
      ? '<span class="pill business">Business</span>'
      : '<span class="pill">' + escape_(r.UserType) + '</span>';
    const consentPill = asBool(r.Consent) 
      ? '<span class="pill yes">Yes</span>' 
      : '<span class="muted">No</span>';
    
    tr.innerHTML = `
      <td>${escape_(new Date(r.Timestamp).toLocaleString())}</td>
      <td>${escape_(r.Name||'')}</td>
      <td>${escape_(r.Email||'')}</td>
      <td>${escape_(r.Phone||'')}</td>
      <td>${userTypePill}</td>
      <td>${escape_(r.Trade||'')}</td>
      <td>${consentPill}</td>
    `;
    tbody.appendChild(tr);
  });
  statusEl.innerHTML = `<span class="ok">${sorted.length}</span> of ${rows.length}`;
}

async function loadRows(){
  try{
    statusEl.textContent = "Loadingâ€¦";
    const url = DATA_ENDPOINT + (DATA_ENDPOINT.includes('?') ? '&' : '?') + 'cb=' + Date.now();

    const res = await fetch(url, { credentials: "omit" });
    if (!res.ok){
      const txt = await res.text().catch(()=>"(no body)");
      console.error("Fetch failed", res.status, res.statusText, txt);
      statusEl.innerHTML = `<span class="bad">Error: ${res.status} ${res.statusText}</span>`;
      return;
    }
    const ct = res.headers.get("content-type") || "";
    if (!ct.includes("json")){
      const txt = await res.text().catch(()=>"(no body)");
      console.error("Expected JSON but got:", ct, txt);
      statusEl.innerHTML = `<span class="bad">Expected JSON, got ${ct}. Check your Apps Script deployment.</span>`;
      return;
    }

    rows = await res.json();
    sortKey = "Timestamp"; sortDir = "desc";
    updateStats(rows);
    render();
    statusEl.innerHTML = `<span class="ok">Loaded!</span>`;
  }catch(err){
    console.error(err);
    statusEl.innerHTML = `<span class="bad">Error: ${String(err)}</span>`;
  }
}

// Sorting
document.querySelectorAll('thead th').forEach(th=>{
  th.addEventListener('click', ()=>{
    const key = th.getAttribute('data-key');
    if (!key) return;
    if (sortKey === key) sortDir = (sortDir==='asc'?'desc':'asc');
    else { sortKey = key; sortDir = 'asc'; }
    render();
  });
});

// Search
q.addEventListener('input', render);

// Refresh
refreshBtn.addEventListener('click', loadRows);

// Export CSV
exportBtn.addEventListener('click', ()=>{
  const term = (q.value || '').toLowerCase().trim();
  let filtered = rows;
  if (term){
    filtered = rows.filter(r =>
      String(r.Name||'').toLowerCase().includes(term) ||
      String(r.Phone||'').toLowerCase().includes(term) ||
      String(r.Email||'').toLowerCase().includes(term) ||
      String(r.Trade||'').toLowerCase().includes(term)
    );
  }
  const sorted = sortRows(filtered);
  const headers = ["Timestamp","Name","Email","Phone","UserType","Trade","Consent"];
  const csv = [headers.join(",")]
    .concat(sorted.map(r => headers.map(h=>{
      let v = r[h] == null ? '' : String(r[h]);
      if (/[",\n]/.test(v)) v = '"' + v.replace(/"/g,'""') + '"';
      return v;
    }).join(",")))
    .join("\n");

  const blob = new Blob([csv], {type:"text/csv;charset=utf-8"});
  const a = document.createElement('a');
  a.href = URL.createObjectURL(blob);
  a.download = "linktradenetwork-signups.csv";
  document.body.appendChild(a);
  a.click();
  a.remove();
});

// Load on start
loadRows();
</script>
</body>
</html>