<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Thread ‚Äì LinkTradeNetwork</title>
<style>
  :root{
    --bg:#f3f4f6; --ink:#0f172a; --muted:#64748b; --line:#e5e7eb; --card:#ffffff;
    --brand:#0a66c2; --brand2:#004182;
  }
  *{box-sizing:border-box}
  body{margin:0;background:var(--bg);color:var(--ink);
       font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Inter,Roboto,Arial;height:100vh;display:flex;flex-direction:column}
  a{color:inherit;text-decoration:none}

  /* Header */
  header{background:#64748b;color:#fff;box-shadow:0 2px 10px rgba(0,0,0,.12)}
  .bar{max-width:1200px;margin:0 auto;padding:12px 16px;display:flex;align-items:center;gap:12px}
  .brand{display:flex;gap:10px;align-items:center;text-decoration:none;color:#fff}
  .brand b{font-size:18px}
  .nav{margin-left:auto;display:flex;gap:12px}
  .nav a{color:#fff;text-decoration:none;opacity:.95}
  .nav a:hover{opacity:.85}

  /* Chat Layout */
  main{flex:1;display:flex;flex-direction:column}
  .chat-head{padding:12px 16px;background:#fff;border-bottom:1px solid var(--line);display:flex;align-items:center;gap:10px}
  .back{border:1px solid #d1d5db;background:#fff;border-radius:8px;padding:.4rem .6rem;cursor:pointer}
  .title{font-weight:800}
  .sub{font-size:12px;color:#64748b}
  .chat-body{flex:1;overflow:auto;padding:16px;display:flex;flex-direction:column;gap:10px;background:#f9fafb}
  .bubble{max-width:72%;padding:10px 14px;border-radius:16px;font-size:14px;line-height:1.4;word-wrap:break-word}
  .me{align-self:flex-end;background:#dbeafe}
  .them{align-self:flex-start;background:#fff;border:1px solid #e5e7eb}
  .chat-input{display:flex;padding:10px 16px;background:#fff;border-top:1px solid var(--line);gap:10px}
  #msg{flex:1;border:1px solid #d1d5db;border-radius:20px;padding:.6rem .9rem}
  #send{background:var(--brand);color:#fff;border:none;border-radius:20px;padding:.6rem 1rem;font-weight:700;cursor:pointer}
  #send:hover{background:var(--brand2)}
</style>
</head>
<body>

<header>
  <div class="bar">
    <a class="brand" href="../front.html"><span style="font-size:22px">üåç</span><b>LinkTradeNetwork</b></a>
    <div class="nav">
      <a href="../front.html">Home</a>
      <a href="../network.html">Network</a>
      <a href="../messaging.html">Messaging</a>
      <a href="../my-profile.html">My Profile</a>
    </div>
  </div>
</header>

<main>
  <div class="chat-head">
    <button class="back" onclick="location.href='messages.html'">‚Üê Conversations</button>
    <div>
      <div class="title" id="chatName">Loading‚Ä¶</div>
      <div class="sub" id="chatSub"></div>
    </div>
    <div style="margin-left:auto">
      <a href="./terms-messaging.html" style="font-size:12px;text-decoration:underline;color:#0ea5e9">Terms</a>
    </div>
  </div>

  <div class="chat-body" id="chatBody"></div>

  <div class="chat-input">
    <input id="msg" placeholder="Type a message‚Ä¶" disabled>
    <button id="send" disabled>Send</button>
  </div>
</main>

<script>
/* Shared storage keys */
const PKEY='ltnPeople', CKEY='ltnConnections', MKEY='ltnMessages';
const $=id=>document.getElementById(id);
function load(k,d){try{return JSON.parse(localStorage.getItem(k))??d}catch{return d}}
function save(k,v){localStorage.setItem(k,JSON.stringify(v))}

/* Data */
let people=load(PKEY,[]);
let connections=new Set(load(CKEY,[]));
let messages=load(MKEY,{});
let active=null;

function nameOf(p){return `${p?.firstName||''} ${p?.lastName||''}`.trim()||'Unknown'}

/* Open thread by ?to= */
(function init(){
  const sp=new URLSearchParams(location.search);
  const id=sp.get('to');
  if(!id){
    $('chatName').textContent='No recipient';
    return;
  }
  active=id;

  const p=people.find(x=>x.id===id);
  if(!p){
    $('chatName').textContent='Unknown contact';
  }else{
    $('chatName').textContent=nameOf(p);
    $('chatSub').textContent=p.trade||p.location||'';
  }

  $('msg').disabled=false; $('send').disabled=false;
  renderThread();

  // Clean URL (optional)
  if(history.replaceState){ history.replaceState({}, document.title, 'thread.html'); }
})();

/* Render messages */
function renderThread(){
  const body=$('chatBody');
  body.innerHTML='';
  const thread=messages[active]||[];
  thread.forEach(m=>{
    const div=document.createElement('div');
    div.className='bubble '+(m.me?'me':'them');
    div.textContent=m.text;
    body.appendChild(div);
  });
  body.scrollTop=body.scrollHeight;
}

/* Send message */
$('send').onclick=sendNow;
$('msg').addEventListener('keydown',e=>{ if(e.key==='Enter'){ e.preventDefault(); sendNow(); }});

function sendNow(){
  const t=$('msg').value.trim();
  if(!t||!active) return;
  messages[active]=messages[active]||[];
  messages[active].push({me:true,text:t,ts:Date.now()});
  save(MKEY,messages);
  $('msg').value='';
  renderThread();

  // Demo auto-reply
  setTimeout(()=>{
    messages[active].push({me:false,text:'Thanks! I‚Äôll get back to you.',ts:Date.now()});
    save(MKEY,messages);
    renderThread();
  },800);
}
</script>

</body>
</html>
