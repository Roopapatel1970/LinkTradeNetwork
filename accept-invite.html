<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Accept Invite ‚Äì LinkTradeNetwork</title>
<style>
  :root{ --bg:#f3f4f6; --ink:#0f172a; --muted:#64748b; --card:#ffffff; --brand:#0a66c2; }
  *{box-sizing:border-box}
  body{margin:0;background:var(--bg);color:var(--ink);
       font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Inter,Roboto,Arial}
  header{background:#64748b;color:#fff;box-shadow:0 2px 10px rgba(0,0,0,.12)}
  .bar{max-width:900px;margin:0 auto;padding:12px 16px;display:flex;align-items:center;justify-content:space-between}
  .brand{display:flex;gap:10px;align-items:center;text-decoration:none;color:#fff}
  .brand b{font-size:18px}
  main{max-width:900px;margin:24px auto;padding:0 16px}
  .card{background:#fff;border:1px solid #e5e7eb;border-radius:12px;padding:18px;box-shadow:0 1px 2px rgba(0,0,0,.05)}
  .row{display:flex;gap:12px;align-items:center}
  .ava{width:56px;height:56px;border-radius:50%;background:#eef2ff;display:flex;align-items:center;justify-content:center;overflow:hidden}
  .btn{background:var(--brand);color:#fff;border:none;border-radius:10px;padding:.55rem 1rem;font-weight:700;cursor:pointer}
  .btn.ghost{background:#fff;color:#0f172a;border:1px solid #e5e7eb}
  .muted{color:#64748b}
</style>
</head>
<body>
<header>
  <div class="bar">
    <a class="brand" href="front.html"><span style="font-size:22px">üåç</span><b>LinkTradeNetwork</b></a>
  </div>
</header>

<main>
  <div class="card" id="content">
    <h2>Checking your invite‚Ä¶</h2>
    <p class="muted">Please wait.</p>
  </div>
</main>

<script>
const PKEY='ltnPeople', CKEY='ltnConnections', RKEY='ltnRequests';
function load(k,d){try{return JSON.parse(localStorage.getItem(k))??d}catch{return d}}
function save(k,v){localStorage.setItem(k,JSON.stringify(v))}

function nameOf(p){return `${p.firstName||''} ${p.lastName||''}`.trim()||'Someone'}

(function init(){
  const sp=new URLSearchParams(location.search);
  const raw=sp.get('invite');
  const box=document.getElementById('content');

  if(!raw){ box.innerHTML='<h2>Invite not found</h2><p class="muted">Missing invite code.</p>'; return; }

  let payload=null;
  try{
    payload = JSON.parse(decodeURIComponent(escape(atob(raw))));
  }catch(e){
    box.innerHTML='<h2>Invalid invite</h2><p class="muted">The invite link is not valid.</p>';
    return;
  }

  if(payload?.v!==1 || !payload.inviter){
    box.innerHTML='<h2>Invalid invite</h2><p class="muted">The invite is incomplete.</p>';
    return;
  }

  // Ensure inviter exists in my local people
  let people=load(PKEY,[]);
  const inviter = payload.inviter;

  if(!people.find(p=>p.id===inviter.id)){
    people.unshift({
      id: inviter.id,
      firstName: inviter.firstName || '',
      lastName:  inviter.lastName  || '',
      trade:     inviter.trade     || '',
      location:  inviter.location  || '',
      email:     inviter.email     || '',
      photo:     inviter.photo     || ''
    });
    save(PKEY, people);
  }

  // Mark as an incoming request
  let req=new Set(load(RKEY,[]));
  req.add(inviter.id);
  save(RKEY,[...req]);

  // UI
  box.innerHTML = `
    <h2>Connect with ${nameOf(inviter)}</h2>
    <div class="row" style="margin:10px 0 14px">
      <div class="ava">üë§</div>
      <div>
        <div><b>${nameOf(inviter)}</b></div>
        <div class="muted">${[inviter.trade, inviter.location].filter(Boolean).join(' ‚Ä¢ ')}</div>
        <div class="muted">${inviter.email || ''}</div>
      </div>
    </div>
    <div class="row" style="gap:8px">
      <button class="btn" id="acceptBtn">Accept</button>
      <button class="btn ghost" id="declineBtn">Decline</button>
    </div>
    <p class="muted" style="margin-top:10px">Accepting will add this person to your connections on this device.</p>
  `;

  document.getElementById('acceptBtn').onclick=()=>{
    const cons=new Set(load(CKEY,[]));
    cons.add(inviter.id); save(CKEY,[...cons]);

    // clear the pending request
    const r=new Set(load(RKEY,[])); r.delete(inviter.id); save(RKEY,[...r]);

    box.innerHTML = `
      <h2>You're now connected üéâ</h2>
      <p class="muted">You can start messaging or view your network.</p>
      <div class="row" style="gap:8px;margin-top:8px">
        <a class="btn" href="messaging.html?to=${encodeURIComponent(inviter.id)}">Open Messages</a>
        <a class="btn ghost" href="network.html">View Network</a>
      </div>
    `;
  };

  document.getElementById('declineBtn').onclick=()=>{
    const r=new Set(load(RKEY,[])); r.delete(inviter.id); save(RKEY,[...r]);
    box.innerHTML = `<h2>Invite declined</h2><p class="muted">You can connect later from your Network page.</p>`;
  };
})();
</script>
</body>
</html>
