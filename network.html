<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Network ‚Äì LinkTradeNetwork</title>
<style>
  :root{
    --bg:#f3f4f6; --ink:#0f172a; --muted:#64748b; --line:#e5e7eb; --card:#ffffff;
    --brand:#0a66c2; --brand2:#004182;
  }
  *{box-sizing:border-box}
  body{margin:0;background:var(--bg);color:var(--ink);
       font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Inter,Roboto,Arial}
  a{color:inherit;text-decoration:none}

  /* Header */
  header{background:#64748b;color:#fff;box-shadow:0 2px 10px rgba(0,0,0,.12)}
  .bar{max-width:1200px;margin:0 auto;padding:12px 16px;display:flex;align-items:center;justify-content:space-between}
  .brand{display:flex;gap:10px;align-items:center;text-decoration:none;color:#fff}
  .brand b{font-size:18px}
  .nav a{color:#fff;margin-left:12px;text-decoration:none;opacity:.95}
  .nav a:hover{opacity:.85}

  /* Layout */
  .wrap{max-width:1100px;margin:20px auto;padding:0 14px;display:grid;grid-template-columns:280px 1fr;gap:18px}
  .card{background:var(--card);border:1px solid var(--line);border-radius:12px;box-shadow:0 1px 2px rgba(0,0,0,.05)}
  .pad{padding:14px}

  /* Sidebar */
  .you{display:flex;gap:10px;align-items:center;border:1px solid #e5e7eb;border-radius:10px;padding:10px;margin-bottom:14px;background:#fff}
  .ava{width:48px;height:48px;border-radius:50%;background:#eef2ff;display:flex;align-items:center;justify-content:center;overflow:hidden}
  .ava img{width:100%;height:100%;object-fit:cover}
  .muted{color:var(--muted);font-size:13px}
  .banner{background:#fff7ed;border:1px solid #fed7aa;color:#9a3412;border-radius:10px;padding:10px;margin-bottom:12px}

  .side h3{margin:10px 0}
  .filter .row{display:grid;gap:6px;margin-bottom:10px}
  .filter input{border:1px solid #d1d5db;border-radius:10px;padding:.55rem .7rem}

  /* Requests panel */
  .req-item{display:grid;grid-template-columns:40px 1fr auto;gap:10px;align-items:center;padding:8px 0;border-top:1px solid #f1f5f9}
  .req-item:first-child{border-top:none}
  .mini-ava{width:40px;height:40px;border-radius:50%;background:#eef2ff;display:flex;align-items:center;justify-content:center;overflow:hidden}
  .req-name{font-weight:800}
  .req-meta{font-size:12px;color:#64748b}
  .req-actions{display:flex;gap:6px}
  .badge{display:inline-block;background:#e2e8f0;color:#0f172a;border:1px solid #cbd5e1;border-radius:999px;font-size:12px;padding:.1rem .5rem;margin-left:6px}

  /* Directory */
  .tools{display:flex;gap:10px;align-items:center;margin-bottom:10px}
  .tools input{border:1px solid #d1d5db;border-radius:999px;padding:.6rem .9rem}
  #search{width:240px}
  #globalSearch{flex:1}
  .grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(260px,1fr));gap:12px}
  .person{border:1px solid #e5e7eb;border-radius:12px;padding:12px;background:#fff;display:grid;grid-template-columns:56px 1fr auto;gap:12px;align-items:center}
  .name{font-weight:800}
  .meta{color:#475569;font-size:13px}
  .row{display:flex;gap:8px;flex-wrap:wrap}
  .btn{background:var(--brand);color:#fff;border:none;border-radius:10px;padding:.45rem .8rem;font-weight:700;cursor:pointer}
  .btn:hover{background:var(--brand2)}
  .btn.ghost{background:#fff;color:#0f172a;border:1px solid #e5e7eb}
  .btn.ghost:hover{background:#f8fafc}
  .btn.gray{background:#6b7280}.btn.gray:hover{background:#4b5563}
  .empty{padding:16px;color:#6b7280;text-align:center}
  .spinner{display:inline-block;width:16px;height:16px;border:2px solid #cbd5e1;border-top-color:#0a66c2;border-radius:50%;animation:spin 1s linear infinite;margin-left:6px}
  @keyframes spin{to{transform:rotate(360deg)}}
  @media(max-width:900px){ .wrap{grid-template-columns:1fr} }
</style>
</head>
<body>

<header>
  <div class="bar">
    <a class="brand" href="front.html"><span style="font-size:22px">üåç</span><b>LinkTradeNetwork</b></a>
    <div class="nav">
      <a href="front.html">Home</a>
      <a href="network.html">Network</a>
      <a href="messaging.html">Messaging</a>
      <a href="my-profile.html">My Profile</a>
    </div>
  </div>
</header>

<main class="wrap">
  <!-- Sidebar -->
  <aside class="card pad side">
    <div id="meBanner" class="banner" style="display:none">
      Add your <b>name or email</b> in <a href="build-profile.html" style="text-decoration:underline">Build Profile</a> to send real invites.
    </div>

    <div class="you">
      <div class="ava" id="youAva">üë§</div>
      <div>
        <div id="youName" style="font-weight:800">You</div>
        <div class="muted" id="youHeadline"></div>
      </div>
    </div>

    <h3>Filters</h3>
    <div class="filter">
      <div class="row"><input id="q" placeholder="Search name or trade"></div>
      <div class="row"><input id="fTrade" placeholder="Trade"></div>
      <div class="row"><input id="fLoc" placeholder="Location"></div>
    </div>

    <h3 style="margin-top:12px">Add person (directory)</h3>
    <div class="filter">
      <div class="row"><input id="addName" placeholder="Full name"></div>
      <div class="row"><input id="addTrade" placeholder="Trade"></div>
      <div class="row"><input id="addLoc" placeholder="Location"></div>
      <div class="row"><input id="addEmail" placeholder="Email (optional)"></div>
      <div class="row"><button class="btn gray" id="addBtn" type="button">Add</button></div>
      <div class="muted">Adds a person to the shared directory.</div>
    </div>
  </aside>

  <!-- Main column -->
  <section>
    <!-- Incoming Requests Panel -->
    <div class="card pad" id="requestsCard" style="display:none">
      <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:6px">
        <h3 style="margin:0">Incoming Requests <span id="reqCount" class="badge" style="display:none"></span></h3>
        <button class="btn ghost" id="acceptAllBtn" type="button">Accept All</button>
      </div>
      <div id="requestsList"></div>
      <div class="muted" style="margin-top:8px">These requests are pulled live from the server.</div>
    </div>

    <!-- Directory -->
    <div class="card pad">
      <div class="tools">
        <input id="search" placeholder="Filter visible people">
        <input id="globalSearch" placeholder="Search or add by name/email‚Ä¶ (Enter)">
        <button class="btn ghost" id="showAll" type="button">Show all</button>
      </div>
      <div id="dir" class="grid"></div>
      <div class="muted" style="margin-top:10px">
        Tip: Use <b>Invite Link</b> to connect anyone (copies a unique acceptance URL).
      </div>
    </div>
  </section>
</main>

<!-- ===== Embedded backend adapter (scripts/api.js) ===== -->
<script>
/* Google Apps Script Web App URL (Deploy ‚Üí Anyone with the link) */
const LTN_API_BASE="https://script.google.com/macros/s/AKfycbwvpweco_FFHNvx-XT4JDvULZ0ax9fVG34gJGbk_3zZz6mUYuvUwJo8ayR0ysqrIDyw/exec";

/* Low-level fetch helpers */
async function ltnGet(params={}){const u=new URL(LTN_API_BASE);Object.entries(params).forEach(([k,v])=>{if(v!==undefined&&v!==null)u.searchParams.set(k,v)});const r=await fetch(u.toString(),{method:"GET",mode:"cors"});if(!r.ok)throw new Error("HTTP "+r.status);const d=await r.json().catch(()=>({}));if(d.error)throw new Error(d.error);return d;}
async function ltnPost(payload={}){const r=await fetch(LTN_API_BASE,{method:"POST",mode:"cors",headers:{"Content-Type":"application/json"},body:JSON.stringify(payload)});if(!r.ok)throw new Error("HTTP "+r.status);const d=await r.json().catch(()=>({}));if(d.error)throw new Error(d.error);return d;}

/* High-level API */
const LTN={
  profile:{ save:(profile)=>ltnPost({action:"saveProfile",profile}), get:(q)=>ltnGet({action:"getProfile",...q}) },
  people:{ list:(opts={})=>ltnGet({action:"listPeople",...opts}), add:(p)=>ltnPost({action:"addPerson",person:p}), search:(q)=>ltnGet({action:"searchPeople",q}) },
  invite:{ create:({inviter,toPersonId=null,emailHint=null})=>ltnPost({action:"createInvite",inviter,toPersonId,emailHint}),
           respond:({inviteId,accept})=>ltnPost({action:"respondInvite",inviteId,accept}),
           incoming:({userId,email})=>ltnGet({action:"incomingRequests",userId,email}) },
  connections:{ list:({userId,email})=>ltnGet({action:"listConnections",userId,email}),
                remove:({userId,peerId})=>ltnPost({action:"removeConnection",userId,peerId}) },
  messages:{ list:({userId,peerId,sinceTs=null})=>ltnGet({action:"listMessages",userId,peerId,sinceTs}),
             send:({fromId,toId,text})=>ltnPost({action:"sendMessage",fromId,toId,text}) }
};
function ltnMeLocal(){ try{ return JSON.parse(localStorage.getItem("userProfile:v1"))||null } catch { return null } }
</script>
<!-- ===== Page logic ===== -->
<script>
/* ========= Identity ("me") ========= */
const me = ltnMeLocal(); // from Build Profile page
const meId = (me?.email || me?.id || "").trim();
const meName = `${me?.firstName||""} ${me?.lastName||""}`.trim();

const $=id=>document.getElementById(id);
function avatarHtml(photo){ return photo ? `<img src="${photo}" alt="">` : "üë§" }
function nameOf(p){ return `${p.firstName||""} ${p.lastName||""}`.trim() || "Unknown" }

/* Render "me" */
(function(){
  if(!meId){ $('meBanner').style.display='block'; }
  if(me?.photo) $('youAva').innerHTML = `<img src="${me.photo}" alt="">`;
  $('youName').textContent = meName || 'You';
  $('youHeadline').textContent = me?.headline || '';
})();

/* ========= State ========= */
let people=[];              // directory (server)
let connections=new Set();  // peerId/email (server)
let requests=[];            // [{inviteId, from:{...}}] (server)

/* ========= Load from backend ========= */
async function loadDirectory(){
  const q = ($('q').value || $('search').value || '').trim();
  const trade = ($('fTrade').value || '').trim();
  const location = ($('fLoc').value || '').trim();
  const res = await LTN.people.list({ q, trade, location, limit: 200 });
  people = Array.isArray(res?.people) ? res.people : [];
}
async function loadConnections(){
  if(!meId){ connections=new Set(); return; }
  const res = await LTN.connections.list({ email: meId });
  const arr = Array.isArray(res?.connections) ? res.connections : [];
  connections = new Set(arr.map(c => c.peerId || c.id || c.email || c.userId));
}
async function loadIncoming(){
  if(!meId){ requests=[]; return; }
  const res = await LTN.invite.incoming({ email: meId });
  requests = Array.isArray(res?.requests) ? res.requests : [];
}

/* ========= Render ========= */
function personCard(p){
  const id = p.id || p.email || '';
  const isConn = connections.has(id);
  const req = requests.find(r => (r.from?.id||r.from?.email) === id);

  const btns = isConn
    ? `<button class="btn" onclick="message('${id}')">Message</button>
       <button class="btn ghost" onclick="removeConn('${id}')">Remove</button>`
    : req
      ? `<button class="btn" onclick="acceptInvite('${req.inviteId}')">Accept</button>
         <button class="btn ghost" onclick="declineInvite('${req.inviteId}')">Decline</button>`
      : `<button class="btn" onclick="createInvite('${id}')">Connect</button>
         <button class="btn ghost" onclick="copyInvite('${id}')">Invite Link</button>`;

  return `
    <div class="person">
      <div class="ava">${avatarHtml(p.photo)}</div>
      <div>
        <div class="name">${nameOf(p)}</div>
        <div class="meta">${[p.trade,p.location].filter(Boolean).join(' ‚Ä¢ ')}</div>
      </div>
      <div class="row">${btns}</div>
    </div>`;
}
function renderDirectory(){
  const q = ($('q').value || $('search').value || '').toLowerCase();
  const t = ($('fTrade').value || '').toLowerCase();
  const l = ($('fLoc').value || '').toLowerCase();

  const list = people.filter(p=>{
    const hay=(nameOf(p)+' '+(p.trade||'')+' '+(p.location||'')+' '+(p.email||'')).toLowerCase();
    return (!q || hay.includes(q)) &&
           (!t || (p.trade||'').toLowerCase().includes(t)) &&
           (!l || (p.location||'').toLowerCase().includes(l));
  });

  $('dir').innerHTML = list.length ? list.map(personCard).join('') : `<div class="empty">No matches.</div>`;
}
function renderRequests(){
  const card=$('requestsCard'), countEl=$('reqCount'), listEl=$('requestsList');
  if(!requests.length){ card.style.display='none'; listEl.innerHTML=''; return; }
  card.style.display='block';
  countEl.style.display='inline-block';
  countEl.textContent=requests.length;

  listEl.innerHTML = requests.map(r=>{
    const f = r.from || {};
    return `
      <div class="req-item">
        <div class="mini-ava">${avatarHtml(f.photo)}</div>
        <div>
          <div class="req-name">${nameOf(f)}</div>
          <div class="req-meta">${[f.trade,f.location].filter(Boolean).join(' ‚Ä¢ ')}</div>
        </div>
        <div class="req-actions">
          <button class="btn" onclick="acceptInvite('${r.inviteId}')">Accept</button>
          <button class="btn ghost" onclick="declineInvite('${r.inviteId}')">Decline</button>
        </div>
      </div>`;
  }).join('');
}

/* ========= Combined refresh ========= */
async function refreshAll(spinTargetId=null){
  try{
    if(spinTargetId){ const t=$(spinTargetId); if(t){ t.insertAdjacentHTML('beforeend','<span class="spinner" data-spin></span>'); } }
    await Promise.all([loadDirectory(), loadConnections(), loadIncoming()]);
    renderDirectory();
    renderRequests();
  }catch(err){
    alert('Error loading data: '+ (err?.message||err));
  }finally{
    document.querySelectorAll('[data-spin]').forEach(n=>n.remove());
  }
}
refreshAll();

/* ========= Actions (server) ========= */
window.acceptInvite = async (inviteId)=>{
  try{ await LTN.invite.respond({ inviteId, accept: true }); await refreshAll(); }
  catch(err){ alert('Accept failed: '+(err?.message||err)); }
};
window.declineInvite = async (inviteId)=>{
  try{ await LTN.invite.respond({ inviteId, accept: false }); await refreshAll(); }
  catch(err){ alert('Decline failed: '+(err?.message||err)); }
};
window.removeConn = async (peerId)=>{
  if(!confirm('Remove this connection?')) return;
  try{ await LTN.connections.remove({ userId: meId, peerId }); await refreshAll(); }
  catch(err){ alert('Remove failed: '+(err?.message||err)); }
};
window.message = (peerId)=>{ location.href = `messaging.html?to=${encodeURIComponent(peerId)}`; };

/* Accept All in panel */
$('acceptAllBtn').onclick = async ()=>{
  if(!requests.length) return;
  try{
    await Promise.all(requests.map(r => LTN.invite.respond({ inviteId: r.inviteId, accept: true })));
    await refreshAll();
  }catch(err){ alert('Accept all failed: '+(err?.message||err)); }
};

/* Create + copy invite link (for an existing directory person) */
window.createInvite = async (toPersonId)=>{
  try{
    if(!meId){ alert('Please add your name or email in Build Profile first.'); return; }
    const res = await LTN.invite.create({ inviter: me, toPersonId, emailHint: null });
    const link = inviteAcceptanceUrl(res);
    copyToClipboard(link);
    alert('Invite link copied!');
  }catch(err){ alert('Could not create invite: '+(err?.message||err)); }
};
window.copyInvite = window.createInvite; // alias

function inviteAcceptanceUrl(apiRes){
  const id = apiRes?.inviteId || apiRes?.id || apiRes?.token;
  const u = new URL(window.location.href);
  u.pathname = u.pathname.replace(/[^/]*$/, 'accept-invite.html');
  u.search   = id ? ('?id=' + encodeURIComponent(id)) : '';
  u.hash     = '';
  return u.toString();
}
function copyToClipboard(text){
  if(navigator.clipboard?.writeText){ navigator.clipboard.writeText(text); }
  else { prompt('Copy this link:', text); }
}

/* Add person to shared directory */
$('addBtn').onclick = async ()=>{
  const n = $('addName').value.trim();
  if(!n) return alert('Enter a name');
  const [firstName, ...rest] = n.split(/\s+/);
  const person = {
    firstName,
    lastName: rest.join(' '),
    trade: $('addTrade').value.trim(),
    location: $('addLoc').value.trim(),
    email: $('addEmail').value.trim()
  };
  try{
    await LTN.people.add(person);
    ['addName','addTrade','addLoc','addEmail'].forEach(i=>$(i).value='');
    await refreshAll();
  }catch(err){ alert('Add failed: '+(err?.message||err)); }
};

/* Filters & search */
['q','fTrade','fLoc','search'].forEach(id=>{
  $(id).addEventListener('input', ()=> refreshAll() );
});
$('showAll').onclick = ()=>{
  ['q','fTrade','fLoc','search'].forEach(id=>$(id).value='');
  refreshAll();
};

/* Global quick add/search: creates or finds, then offers invite */
const g=$('globalSearch');
g.addEventListener('keydown', async (e)=>{
  if(e.key!=='Enter') return;
  const val=g.value.trim(); if(!val) return;

  let firstName='', lastName='', email='';
  if(val.includes('@') && val.includes('.')){ email = val; }
  else { const parts = val.split(/\s+/); firstName = parts.shift()||''; lastName = parts.join(' '); }

  try{
    let found=[];
    if(email){ const r = await LTN.people.search(email); found = r?.people||[]; }
    else { const r = await LTN.people.search(val); found = r?.people||[]; }
    let target = found[0];

    if(!target){
      const addRes = await LTN.people.add({ firstName, lastName, email, trade:'', location:'' });
      target = addRes?.person || addRes;
    }

    await refreshAll();
    if(target?.id || target?.email){
      if(confirm(`Invite ${nameOf(target)} to connect?`)){
        await createInvite(target.id || target.email);
      }
    }
  }catch(err){
    alert('Search/add failed: '+(err?.message||err));
  }finally{
    g.value='';
  }
});

/* Handle ?query= from front.html */
(function(){
  const sp=new URLSearchParams(location.search);
  const q=sp.get('query'); if(!q) return;
  g.value=q;
  g.dispatchEvent(new KeyboardEvent('keydown',{key:'Enter',bubbles:true}));
  if(history.replaceState){ history.replaceState({},'', 'network.html'); }
})();
</script>
</body>
</html>




