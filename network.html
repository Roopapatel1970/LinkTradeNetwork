<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Network ‚Äì LinkTradeNetwork</title>
<style>
  :root{
    --bg:#f3f4f6; --ink:#0f172a; --muted:#64748b; --line:#e5e7eb; --card:#ffffff;
    --brand:#0a66c2; --brand2:#004182; --hover:#f8fafc;
  }
  *{box-sizing:border-box}
  body{margin:0;background:var(--bg);color:var(--ink);
       font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Inter,Roboto,Arial}
  a{color:inherit;text-decoration:none}

  /* Header */
  header{background:#64748b;color:#fff;box-shadow:0 2px 10px rgba(0,0,0,.12)}
  .bar{max-width:1100px;margin:0 auto;padding:12px 16px;display:flex;align-items:center;justify-content:space-between}
  .brand{display:flex;gap:10px;align-items:center}
  .brand b{font-size:18px}
  .nav a{color:#fff;opacity:.95;margin-left:12px}
  .nav a:hover{opacity:.85}

  /* Layout */
  .wrap{max-width:1100px;margin:18px auto;padding:0 14px;display:grid;grid-template-columns:280px 1fr;gap:18px}
  .card{background:var(--card);border:1px solid var(--line);border-radius:12px;box-shadow:0 1px 2px rgba(0,0,0,.05)}
  .pad{padding:14px}

  /* Sidebar */
  .side h3{margin:0 0 10px}
  .filter .row{display:grid;gap:6px;margin-bottom:10px}
  .filter input, .filter select{border:1px solid #d1d5db;border-radius:10px;padding:.55rem .7rem}

  .you{display:flex;gap:10px;align-items:center;border:1px solid #e5e7eb;border-radius:10px;padding:10px;margin-bottom:14px;background:#fff}
  .ava{width:48px;height:48px;border-radius:50%;background:#eef2ff;display:flex;align-items:center;justify-content:center;overflow:hidden}
  .ava img{width:100%;height:100%;object-fit:cover}
  .muted{color:var(--muted);font-size:13px}

  /* Directory */
  .tools{display:flex;gap:10px;align-items:center;margin-bottom:10px}
  .tools input{flex:1;border:1px solid #d1d5db;border-radius:999px;padding:.6rem .9rem}
  .grid{display:grid;grid-template-columns:repeat(2,1fr);gap:12px}
  .person{border:1px solid #e5e7eb;border-radius:12px;padding:12px;background:#fff;display:grid;grid-template-columns:56px 1fr auto;gap:12px;align-items:center}
  .name{font-weight:800}
  .meta{color:#475569;font-size:13px}
  .row{display:flex;gap:8px;flex-wrap:wrap}
  .btn{background:var(--brand);color:#fff;border:none;border-radius:10px;padding:.45rem .8rem;font-weight:800;cursor:pointer}
  .btn:hover{background:var(--brand2)}
  .btn.ghost{background:#fff;color:#0f172a;border:1px solid #e5e7eb}
  .btn.ghost:hover{background:#f8fafc}
  .btn.gray{background:#6b7280}.btn.gray:hover{background:#4b5563}
  .empty{padding:16px;color:#6b7280;text-align:center}
  @media(max-width:900px){ .wrap{grid-template-columns:1fr} .grid{grid-template-columns:1fr} }
</style>
</head>
<body>
<header>
  <div class="bar">
    <a class="brand" href="front.html"><span style="font-size:22px">üåç</span><b>LinkTradeNetwork</b></a>
    <div class="nav">
      <a href="front.html">Home</a>
      <a href="network.html">Network</a>
      <a href="messaging.html">Messaging</a>
      <a href="my-profile.html">My Profile</a>
    </div>
  </div>
</header>

<main class="wrap">
  <!-- LEFT: You + Filters + Add Person -->
  <aside class="card pad side">
    <div class="you">
      <div class="ava" id="youAva">üë§</div>
      <div>
        <div id="youName" style="font-weight:800">You</div>
        <div class="muted" id="youHeadline"></div>
      </div>
    </div>

    <h3>Filters</h3>
    <div class="filter">
      <div class="row">
        <label>Search</label>
        <input id="q" placeholder="Name, trade, location">
      </div>
      <div class="row">
        <label>Trade</label>
        <input id="fTrade" placeholder="e.g., Fiber, Cabling">
      </div>
      <div class="row">
        <label>Location</label>
        <input id="fLoc" placeholder="City or State">
      </div>
    </div>

    <h3 style="margin-top:12px">Add person (local)</h3>
    <div class="filter">
      <div class="row"><input id="addName" placeholder="Full name"></div>
      <div class="row"><input id="addTrade" placeholder="Trade"></div>
      <div class="row"><input id="addLoc" placeholder="Location"></div>
      <div class="row"><input id="addEmail" placeholder="Email (optional)"></div>
      <div class="row"><button class="btn gray" id="addBtn" type="button">Add</button></div>
      <div class="muted">Adds to your local directory only.</div>
    </div>
  </aside>

  <!-- RIGHT: Directory -->
  <section class="card pad">
    <div class="tools">
      <input id="search" placeholder="Search people">
      <button class="btn ghost" id="showAll" type="button">Show all</button>
    </div>
    <div id="dir" class="grid"></div>
    <div class="muted" style="margin-top:10px">
      Tip: Click <b>Invite Link</b> and share that URL. When the other person opens it, they‚Äôll see your request to connect.
    </div>
  </section>
</main>

<script>
/* ===== Keys shared with messaging ===== */
const PKEY='ltnPeople';      // people directory
const CKEY='ltnConnections'; // accepted connection ids
const RKEY='ltnRequests';    // pending incoming requests
const MEKEY='userProfile:v1';

const $=id=>document.getElementById(id);
function load(k,d){ try{return JSON.parse(localStorage.getItem(k)) ?? d}catch{return d} }
function save(k,v){ localStorage.setItem(k, JSON.stringify(v)) }

/* ===== Seed data (only if empty) ===== */
function seed(){
  if(!load(PKEY,[]).length){
    const demo=[
      {id:'p-rosa',firstName:'Rosa',lastName:'Vega',trade:'Tower/Fiber Tech',location:'Milwaukee, WI',email:'rosa@example.com',photo:''},
      {id:'p-tim',firstName:'Tim',lastName:'McCarron',trade:'Cabling',location:'Madison, WI',email:'tim@example.com',photo:''},
      {id:'p-lee',firstName:'Lee',lastName:'Khan',trade:'Access Control',location:'Chicago, IL',email:'lee@example.com',photo:''},
      {id:'p-sam',firstName:'Sam',lastName:'Park',trade:'Low Voltage',location:'Detroit, MI',email:'sam@example.com',photo:''}
    ];
    save(PKEY,demo);
  }
  if(!Array.isArray(load(CKEY,null))) save(CKEY,[]);
  if(!Array.isArray(load(RKEY,null))) save(RKEY,[]);
}
seed();

/* ===== Me card ===== */
let me=load(MEKEY,null);
(function renderMe(){
  const ava=$('youAva'), nm=$('youName'), hd=$('youHeadline');
  if(me?.photo) ava.innerHTML=`<img src="${me.photo}" alt="you">`; else ava.textContent='üë§';
  nm.textContent = me ? `${me.firstName||''} ${me.lastName||''}`.trim() || 'You' : 'You';
  hd.textContent = me?.headline || '';
})();

/* ===== State & filters ===== */
let people=load(PKEY,[]);
let connections=new Set(load(CKEY,[]));
let requests=new Set(load(RKEY,[]));
let filter={q:'',trade:'',loc:''};

/* ===== Helpers ===== */
function nameOf(p){ return `${p.firstName||''} ${p.lastName||''}`.trim() }
function avatarHtml(p){ return p?.photo ? `<img src="${p.photo}" alt="">` : 'üë§' }
function personCard(p){
  const id=p.id;
  const isConn = connections.has(id);
  const isReq  = requests.has(id);
  const btns = isConn
    ? `<button class="btn" onclick="message('${id}')">Message</button>
       <button class="btn ghost" onclick="removeConn('${id}')">Remove</button>`
    : isReq
      ? `<button class="btn" onclick="accept('${id}')">Accept</button>
         <button class="btn ghost" onclick="decline('${id}')">Decline</button>`
      : `<button class="btn" onclick="connect('${id}')">Connect</button>
         <button class="btn ghost" onclick="copyInvite('${id}')">Invite Link</button>`;
  return `
    <div class="person">
      <div class="ava">${avatarHtml(p)}</div>
      <div>
        <div class="name">${nameOf(p)}</div>
        <div class="meta">${[p.trade,p.location].filter(Boolean).join(' ‚Ä¢ ')}</div>
        <div class="muted">${p.email||''}</div>
      </div>
      <div class="row">${btns}</div>
    </div>`;
}

/* ===== Directory render ===== */
function render(){
  people = load(PKEY,[]);
  connections = new Set(load(CKEY,[]));
  requests = new Set(load(RKEY,[]));

  const q = (filter.q||'').toLowerCase();
  const t = (filter.trade||'').toLowerCase();
  const l = (filter.loc||'').toLowerCase();

  const list = people.filter(p=>{
    const hay = (nameOf(p)+' '+(p.trade||'')+' '+(p.location||'')+' '+(p.email||'')).toLowerCase();
    if(q && !hay.includes(q)) return false;
    if(t && !(p.trade||'').toLowerCase().includes(t)) return false;
    if(l && !(p.location||'').toLowerCase().includes(l)) return false;
    return true;
  });

  $('dir').innerHTML = list.length ? list.map(personCard).join('') : `<div class="empty">No people match your filters.</div>`;
}
render();

/* ===== Actions (local) ===== */
window.connect = function(id){
  // Same-device demo: shows an incoming request
  requests.add(id); save(RKEY,[...requests]); render();
  alert('Request sent (demo). If you want to share to another device, use Invite Link.');
};
window.accept = function(id){
  requests.delete(id); connections.add(id);
  save(RKEY,[...requests]); save(CKEY,[...connections]); render();
};
window.decline = function(id){
  requests.delete(id); save(RKEY,[...requests]); render();
};
window.removeConn = function(id){
  if(confirm('Remove this connection?')){
    connections.delete(id); save(CKEY,[...connections]); render();
  }
};
window.message = function(id){
  location.href = `messaging.html?to=${encodeURIComponent(id)}`;
};

/* ===== Filters & search ===== */
$('search').addEventListener('input', e=>{ filter.q=e.target.value; render(); });
$('q').addEventListener('input', e=>{ filter.q=e.target.value; render(); });
$('fTrade').addEventListener('input', e=>{ filter.trade=e.target.value; render(); });
$('fLoc').addEventListener('input', e=>{ filter.loc=e.target.value; render(); });
$('showAll').onclick=()=>{ filter={q:'',trade:'',loc:''}; $('search').value=''; $('q').value=''; $('fTrade').value=''; $('fLoc').value=''; render(); };

/* ===== Add person (local only) ===== */
$('addBtn').onclick=()=>{
  const name=$('addName').value.trim();
  const trade=$('addTrade').value.trim();
  const loc=$('addLoc').value.trim();
  const email=$('addEmail').value.trim();
  if(!name){ alert('Enter a name'); return; }
  const [firstName,...rest]=name.split(' ');
  const lastName=rest.join(' ');
  const person={id:'p-'+Date.now(),firstName,lastName,trade,location:loc,email,photo:''};
  const arr=load(PKEY,[]); arr.unshift(person); save(PKEY,arr);
  $('addName').value=''; $('addTrade').value=''; $('addLoc').value=''; $('addEmail').value='';
  render();
};

/* =========================
   OPTION A: INVITE LINKS
   ========================= */

/* Minimal identity for the inviter (you) */
function myProfile() {
  const me = load(MEKEY, null);
  const name = me ? `${me.firstName||''} ${me.lastName||''}`.trim() : '';
  // Build a stable inviter id: prefer email; else name; else fallback
  const baseId = (me?.email || name || 'user').toLowerCase().replace(/\s+/g,'-');
  return {
    id: baseId,
    firstName: me?.firstName || '',
    lastName:  me?.lastName  || '',
    email:     me?.email     || '',
    trade:     me?.trade     || '',
    location:  me?.location  || '',
    photo:     me?.photo     || ''
  };
}

/* Build + copy the invite link to clipboard */
window.copyInvite = function(targetId){
  const inviter = myProfile();
  if(!inviter.email && !inviter.firstName && !inviter.lastName){
    alert('Add your name or email in Build Profile first.');
    return;
  }
  const payload = { v:1, inviter, to: targetId, ts: Date.now() };
  const encoded = btoa(unescape(encodeURIComponent(JSON.stringify(payload))));
  // Build URL pointing back to this page in the same folder
  const baseHref = (()=>{
    // Works for both http(s) and file protocol; keeps current folder
    const url = new URL(window.location.href);
    // Replace filename with network.html
    const parts = url.pathname.split('/');
    parts[parts.length-1] = 'network.html';
    url.pathname = parts.join('/');
    url.search = ''; url.hash = '';
    return url.toString();
  })();
  const url  = `${baseHref}?invite=${encodeURIComponent(encoded)}`;

  if(navigator.clipboard?.writeText){
    navigator.clipboard.writeText(url).then(()=>{
      alert('Invite link copied. Send it by text/email. When they open it, they‚Äôll see your request.');
    }, ()=>{
      prompt('Copy this link:', url);
    });
  }else{
    prompt('Copy this link:', url);
  }
};

/* Handle incoming invite links on load */
(function handleIncomingInvite(){
  const sp = new URLSearchParams(location.search);
  const raw = sp.get('invite');
  if(!raw) return;
  try{
    const payload = JSON.parse(decodeURIComponent(escape(atob(raw))));
    if(payload?.v!==1) return;

    // Load storage
    const people = load(PKEY, []);
    const reqs = new Set(load(RKEY, []));

    // Ensure inviter is in recipient's directory
    if(!people.find(p=>p.id===payload.inviter.id)){
      people.unshift({
        id: payload.inviter.id,
        firstName: payload.inviter.firstName,
        lastName:  payload.inviter.lastName,
        trade:     payload.inviter.trade,
        location:  payload.inviter.location,
        email:     payload.inviter.email,
        photo:     payload.inviter.photo || ''
      });
      save(PKEY, people);
    }

    // Add incoming request from inviter
    reqs.add(payload.inviter.id);
    save(RKEY, [...reqs]);

    // Clean the URL (optional)
    if(history.replaceState){
      history.replaceState({}, document.title, 'network.html');
    }

    // Re-render
    if(typeof render==='function') render();

    alert(`Connection request from ${payload.inviter.firstName||''} ${payload.inviter.lastName||''}`);
  }catch(e){
    console.warn('Bad invite link:', e);
  }
})();
</script>
</body>
</html>

